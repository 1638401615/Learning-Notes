# 3.1 传输层服务

传输层协议为运行在不同Host上的**进程**提供了一种**逻辑通信协议**

传输层协议只工作在端系统上

## 多路复用和多路分用

* 复用：发送给网络层的时候要把不同线程的信息合起来
* 分解：接收多个线程的信息的时候，网络层只发送一个整合好的回来，自己把它分割给不同的线程

> 自顶向下中解释：
>
> 多路分解：将运输层报文段的数据交付到正确的套接字
>
> 多路复用：源主机从不同套接字中接受数据块，为每个数据块封装首部信息（用于以后分解）从而生成报文段，然后将报文段传递到网络层。

## UDP

* 基于Internet IP协议

  复用/分用

  简单错误校验（校验和）

* Best effort 服务，UDP段可能丢失/非按序到达

* 无连接

  UDP发送方与接收方不需要握手

  每个UDP段处理独立于其他段

## 可靠数据传输原理

### 可靠数据传输协议

* RDT 1.0:可靠信道上的可靠数据传输协议

* RDT 2.0:产生位错误的信道

  确认机制显示告诉发送方分组是否正确

  ACK：正确接收 NAK：接受错误，**重传**分组

  基于**重传机制**的RDT协议称为ARQ协议

* RDT 2.1：应对ACK/NAK信息被破坏

  解决重复分组问题：发送方给每个分组增加序列号，接收方就丢弃重复分组

* RDT 3.0：信道既可能发生错误，也可能丢失分组

  发送方等待合理时间（定时器），未收到ACK就重传

  能工作，但性能很差，即网络协议限制了物理资源的利用

### 流水线可靠数据传输协议

流水线差错恢复：

* 回退N步（滑动窗口协议）：窗口长度必须小于或等于序号空间大小的一半
* 选择重传

## 面向连接的运输:TCP

### TCP连接

* 三次握手
* TCP协议只在端系统上运行，两台主机之间的网络元素（路由器，交换器和中继器）中，没有为该连接分配任何缓存和变量
* 累积确认：TCP只确认该流中至第一个丢失字节为止的字节。eg：A收到B包含字节0~535和900~1000的报文段，返回给B的下一个报文段确认号字段包含536。

### 流量控制

发送方的发送速率和接收方应用程序的读取速率相匹配，UDP没有提供流量控制

当接收方发回的RcvWindow=0时，发送方仍可发一个只有一个字节的报文段过去。

### 三次握手

1. 客户向服务器发**SYN报文段**（SYN置1），随机选择初始序号
2. 服务器从数据报中提取TCP SYN报文段，为TCP连接分配TCP缓存和变量（此处易受到SYN洪范的拒绝服务攻击），想客户TCO发送允许连接报文段，其中SYN比特置1，确认号字段为客户端**初始序号+1**，还有服务器自己的初始序号，该报文段被称为**SYNACK报文段**
3. 收到SYNACK报文段，客户也要为TCP连接分配缓存和变量，发送报文对服务器允许连接报文进行确认，其中确认字段为服务器初始序号+1，该报文、SYN比特置0。第三阶段可以再报文负载中携带客户到服务器的数据。

关闭TCP连接：FIN比特置1，客户发服务器，服务器接收。服务器再发FIN为1报文给客户。双方至此都对对方的终止报文段确认，TCP断开连接。

### 拥塞控制原理

#### 拥塞产生代价：

1. 分组到达速率接近链路容量，分组经历巨大排队时延
2. 发送方必须执行重传以不补偿因为缓存溢出而丢失的分组
3. 发送方在遇到大的时延时所进行的不必要重传会引起路由器利用其链路带宽来转发不必要分组副本
4. 当一个分组沿一条路径被丢弃时，每个上游路由器用于转发该分组到丢弃该分组而使用的传输容量最终被浪费掉了

#### 拥塞控制方法:

* 端到端拥塞控制
* 网络辅助的拥塞控制（网络路由器直接反馈和经由接收方的网络反馈）

#### 拥塞控制算法

1. 慢启动
2. 拥塞避免
3. 快速恢复（非必须）
