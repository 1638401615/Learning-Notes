# 三件套的使用

## Gorm(ORM)

![image-20230117100638846](笔记图片/image-20230117100638846.png)

* First只能查询单条数据

<img src="笔记图片/image-20230117102305387.png" alt="image-20230117102305387" style="zoom:50%;" />

* 

### Gorm查询数据

* 用结构作为条件查询，**不会把零值字段构建查询条件，所以需要使用Map来构建查询条件**

![image-20230117102444795](笔记图片/image-20230117102444795.png)

### Gorm更新数据

* **使用struct更新的时候，也只会更新非0值，需要更新零值需要用Map更新或者Select显式选择字段**

![image-20230117102909550](笔记图片/image-20230117102909550.png)

### Gorm删除数据

* 物理删除

  数据真正从数据库中被删除了

* 软删除

  Gorm提供了gorm.DeletedAt帮助用户实现软删。

  拥有软删除能力的model调用delete的时候，记录不会从数据库中被真正删除，但是gorm会将DeletedAt置为当前时间，并且不能通过正常查询方法再找到该记录，得用Unscoped去查询

### GORM事务

* Gorm提供了Begin、Commit、Rollback方法用于使用事务

  ![image-20230118142846032](笔记图片/image-20230118142846032.png)

* Gorm提供了Transaction方法用于自动提交事务，避免用户漏写commit、Rollback（推荐使用）

  ![image-20230118143206128](笔记图片/image-20230118143206128.png)

### Gorm Hook

![image-20230118143458854](笔记图片/image-20230118143458854.png)

### Gorm性能提高

![image-20230118143633572](笔记图片/image-20230118143633572.png)

## Kitex(RPC)

* 对Windows支持不完善，代码生成工具无法使用，用虚拟机或者WSL2

![image-20230118161949858](笔记图片/image-20230118161949858.png)

### Kitex基本使用

* 服务默认监听8888端口

![image-20230118162417193](笔记图片/image-20230118162417193.png)

![image-20230118162358016](笔记图片/image-20230118162358016.png)

![image-20230118162446995](笔记图片/image-20230118162446995.png)

## Hertz(HTTP)

### Hertz基本使用

![image-20230118163258250](笔记图片/image-20230118163258250.png)

### Hertz路由

![image-20230118163536142](笔记图片/image-20230118163536142.png)

![image-20230118163636086](笔记图片/image-20230118163636086.png)

* hertz的路由优先级：静态路由>命名路由>通配路由

### Hertz参数绑定

* 参数绑定：把http请求中的参数转移到结构体中

![image-20230118164853502](笔记图片/image-20230118164853502.png)

* bind也是要写回值的，所以要**传递指针进去**

### Hertz中间件

* 用中间件的场景：语言信息的设置和传递等通用的场景

![image-20230118165420765](笔记图片/image-20230118165420765.png)

* 实例中直接把中间件注册在了hertz对象上了，所以是全局的，也可以注册在某一路由或者路由组上

> 注册在全局的中间件 vs 注册在路由组上面的中间件？
>
> 如果页面返回404的话，这中间件是否还会触发

### Hertz Client

![image-20230118165719065](笔记图片/image-20230118165719065.png)

### Hertz 代码生成工具

![image-20230118165907964](笔记图片/image-20230118165907964.png)

### Hertz 性能

1. 网络库Netpoll
2. Json编解码Sonic
3. 使用Sync.Pool复用对象协议层数据解析优化

## 实战案例介绍

<img src="笔记图片/image-20230118171215302.png" alt="image-20230118171215302" style="zoom:67%;" />

<img src="笔记图片/image-20230118171123203.png" alt="image-20230118171123203" style="zoom:67%;" />

* user和note服务才会和MySQL打交道

<img src="笔记图片/image-20230118171422027.png" alt="image-20230118171422027" style="zoom:67%;" />

# 总结

* Gorm就是个ORM框架，用于操纵数据库
* Kitex是RPC框架，把一些基础服务抽象出来，便于其他API服用，搭建微服务框架
* Hertz是HTTP框架，对外提供API服务，用来接口聚合